<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/pico.min.css" />
  </head>
  <body>
    <h1>Restore Backup</h1>
    <h2 id="counter">0 of 4</h2>

    <video
      autoplay=""
      style="border: 1px solid black; width: 800px; height: 800px"
    ></video>

    <button onclick="onGetUserMediaButtonClick()">Capture</button>

    <form method="post" action="/api-restore">
      <input type="password" name="passphrase" />
      <button onclick="onRestoreClick()">Restore</button>
    </form>

    <script>
      var imageCapture;
      var previousParts = 0;

      async function onRestoreClick() {
        const response = await fetch("/api-restore", {
          method: "POST",
          body: formData,
        });
      }

      function onGetUserMediaButtonClick() {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then((mediaStream) => {
            document.querySelector("video").srcObject = mediaStream;

            const track = mediaStream.getVideoTracks()[0];
            imageCapture = new ImageCapture(track);

            grabFrameButton();
          })
          .catch((error) => console.log(error));
      }

      async function imageBitmapToBlob(imageBitmap) {
        // Create an OffscreenCanvas
        const offscreenCanvas = new OffscreenCanvas(
          imageBitmap.width,
          imageBitmap.height,
        );
        // Get a rendering context
        const ctx = offscreenCanvas.getContext("2d");
        // Draw the ImageBitmap onto the canvas
        ctx.drawImage(imageBitmap, 0, 0);

        // Convert the canvas content to a Blob (as PNG by default, or specify 'image/jpeg' and quality)
        const blob = await offscreenCanvas.convertToBlob();

        return blob;
      }

      function grabFrameButton() {
        const id = setInterval(() => {
          imageCapture
            .grabFrame()
            .then(async (bmp) => {
              const blob = await imageBitmapToBlob(bmp);
              const formData = new FormData();
              formData.append("image", blob, "filename.png");

              const response = await fetch("/api-qr-frame", {
                method: "POST",
                body: formData,
              });

              const result = await response.json();

              if (result?.parts === 4) {
                clearInterval(id);
              }

              if (result?.parts && result.parts > previousParts) {
                confirm("got new part");
              }
              previousParts = result?.parts ?? previousParts;
              document
                .querySelector("#counter")
                ?.setHTMLUnsafe(`${previousParts ?? 0} of 4`);
            })
            .catch(() => {
              // noop
            });
        }, 1000);
      }

      function drawCanvas(canvas, img) {
        canvas.width = getComputedStyle(canvas).width.split("px")[0];
        canvas.height = getComputedStyle(canvas).height.split("px")[0];
        let ratio = Math.min(
          canvas.width / img.width,
          canvas.height / img.height,
        );
        let x = (canvas.width - img.width * ratio) / 2;
        let y = (canvas.height - img.height * ratio) / 2;
        canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
        canvas
          .getContext("2d")
          .drawImage(
            img,
            0,
            0,
            img.width,
            img.height,
            x,
            y,
            img.width * ratio,
            img.height * ratio,
          );
      }
    </script>
  </body>
</html>
